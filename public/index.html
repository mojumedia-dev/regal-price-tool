<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Regal Homes - Price Update Tool</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Source Sans 3', sans-serif; background: #F8F7F5; color: #2D2D2D; }
    
    /* Login */
    .login-page { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #6B1D2A 0%, #4A1420 100%); }
    .login-card { background: white; border-radius: 8px; padding: 48px; width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .login-card img { width: 80px; margin-bottom: 16px; }
    .login-card h1 { font-family: 'Playfair Display', serif; font-size: 24px; color: #6B1D2A; margin-bottom: 8px; }
    .login-card p { color: #888; font-size: 14px; margin-bottom: 24px; }
    .login-card input { width: 100%; padding: 12px 16px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; margin-bottom: 12px; font-family: inherit; }
    .login-card input:focus { outline: none; border-color: #6B1D2A; }
    .login-card button { width: 100%; padding: 12px; background: #6B1D2A; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; }
    .login-card button:hover { background: #551624; }
    .login-error { color: #c0392b; font-size: 13px; margin-bottom: 12px; display: none; }
    
    /* App */
    .app { display: none; }
    .topbar { background: #6B1D2A; color: white; padding: 12px 32px; display: flex; justify-content: space-between; align-items: center; }
    .topbar-left { display: flex; align-items: center; gap: 12px; }
    .topbar img { width: 40px; height: 40px; }
    .topbar h1 { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 400; }
    .topbar-right { display: flex; align-items: center; gap: 16px; font-size: 14px; }
    .topbar-right button { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-family: inherit; }
    .topbar-right button:hover { background: rgba(255,255,255,0.25); }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    
    /* Community selector */
    .community-selector { margin-bottom: 24px; }
    .community-selector select { padding: 12px 40px 12px 20px; font-size: 18px; border: 2px solid #6B1D2A; border-radius: 8px; font-family: 'Playfair Display', serif; color: #6B1D2A; background: white; min-width: 320px; cursor: pointer; appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%236B1D2A' d='M6 8L0 0h12z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; }
    .community-selector select:hover { border-color: #4A1420; box-shadow: 0 2px 8px rgba(107,29,42,0.15); }
    .community-selector select:focus { outline: none; border-color: #4A1420; box-shadow: 0 0 0 3px rgba(107,29,42,0.1); }
    
    /* Tabs */
    .tabs { display: flex; gap: 0; margin-bottom: 0; border-bottom: 2px solid #6B1D2A; }
    .tab { padding: 12px 24px; cursor: pointer; font-weight: 600; font-size: 14px; color: #888; background: #F0EDED; border-radius: 6px 6px 0 0; margin-right: 2px; border: 1px solid #ddd; border-bottom: none; transition: all 0.2s; }
    .tab.active { background: #6B1D2A; color: white; border-color: #6B1D2A; }
    .tab:hover:not(.active) { background: #E8E0E0; color: #6B1D2A; }
    
    /* Tab Content */
    .tab-content { display: none; background: white; border-radius: 0 0 8px 8px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .tab-content.active { display: block; }
    
    /* Tables */
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th { background: #6B1D2A; color: white; padding: 10px 12px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; text-align: center; }
    .data-table th:first-child { text-align: left; }
    .data-table td { padding: 10px 12px; text-align: center; border-bottom: 1px solid #F0F0F0; font-size: 13px; }
    .data-table td:first-child { text-align: left; font-weight: 500; }
    .data-table tr:nth-child(even) { background: #FAFAFA; }
    .data-table tr:hover { background: #FFF5F5; }
    
    /* Price input */
    .price-input { width: 120px; padding: 6px 8px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px; font-weight: 600; text-align: right; font-family: inherit; color: #6B1D2A; }
    .price-input:focus { outline: none; border-color: #6B1D2A; box-shadow: 0 0 0 3px rgba(107,29,42,0.1); }
    .price-input.changed { border-color: #E67E22; background: #FEF9E7; }
    .price-input.saved { border-color: #27AE60; background: #EAFAF1; }
    .field-input { width: 100%; padding: 5px 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px; font-family: inherit; text-align: center; background: transparent; }
    .field-input:focus { outline: none; border-color: #6B1D2A; background: white; box-shadow: 0 0 0 2px rgba(107,29,42,0.1); }
    .field-input.changed { border-color: #E67E22; background: #FEF9E7; }
    .field-input.saved { border-color: #27AE60; background: #EAFAF1; }
    .field-input.short { width: 70px; }
    
    /* Actions */
    .actions { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
    .btn { padding: 10px 24px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: #6B1D2A; color: white; }
    .btn-primary:hover { background: #551624; }
    .btn-primary:disabled { background: #CCC; cursor: not-allowed; }
    .btn-secondary { background: white; color: #6B1D2A; border: 2px solid #6B1D2A; }
    .btn-secondary:hover { background: #FFF5F5; }
    .btn-success { background: #27AE60; color: white; }
    
    .save-status { font-size: 13px; color: #888; }
    .save-status.success { color: #27AE60; }
    .save-status.error { color: #c0392b; }
    
    /* PDF buttons */
    .pdf-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    
    /* Audit log */
    .audit-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .audit-table th { background: #F5F5F5; padding: 8px; text-align: left; font-weight: 600; color: #666; font-size: 11px; text-transform: uppercase; }
    .audit-table td { padding: 8px; border-bottom: 1px solid #F0F0F0; }
    
    .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
    .badge-plan { background: #EBF5FB; color: #2980B9; }
    .badge-lot { background: #F5EEF8; color: #8E44AD; }
    .badge-home { background: #FDEBD0; color: #E67E22; }

    /* Toast */
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 24px; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; z-index: 1000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
    .toast.show { opacity: 1; }
    .toast.success { background: #27AE60; }
    .toast.error { background: #c0392b; }
    .toast.info { background: #2980B9; }

    .generating { opacity: 0.6; pointer-events: none; }

    /* Homefiniti Sync */
    .sync-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .sync-badge.pending { background: #FEF9E7; color: #E67E22; animation: pulse 1.5s infinite; }
    .sync-badge.synced { background: #EAFAF1; color: #27AE60; }
    .sync-badge.failed { background: #FDEDEC; color: #E74C3C; cursor: pointer; }
    .sync-badge.none { background: #F0F0F0; color: #999; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .btn-sync { padding: 4px 10px; font-size: 11px; background: #3498DB; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: inherit; }
    .btn-sync:hover { background: #2980B9; }
    .btn-sync:disabled { background: #BDC3C7; cursor: not-allowed; }
  </style>
</head>
<body>

<!-- Login Page -->
<div class="login-page" id="loginPage">
  <div class="login-card">
    <img src="/logo.png" alt="Regal Homes">
    <h1>Price Update Tool</h1>
    <p>Sign in to manage pricing</p>
    <div class="login-error" id="loginError"></div>
    <form id="loginForm">
      <input type="email" id="loginEmail" placeholder="Email" required>
      <input type="password" id="loginPassword" placeholder="Password" required>
      <button type="submit">Sign In</button>
    </form>
  </div>
</div>

<!-- App -->
<div class="app" id="app">
  <div class="topbar">
    <div class="topbar-left">
      <img src="/logo.png" alt="RH">
      <h1>Regal Homes Price Tool</h1>
    </div>
    <div class="topbar-right">
      <span id="userName"></span>
      <button onclick="showAuditLog()">üìã Audit Log</button>
      <button onclick="logout()">Sign Out</button>
    </div>
  </div>
  
  <div class="container">
    <div class="community-selector">
      <select id="communitySelect" onchange="loadCommunity()"></select>
    </div>
    
    <div class="tabs">
      <div class="tab active" onclick="switchTab('homesites')">üè° Homesites</div>
      <div class="tab" onclick="switchTab('base-prices')">üí∞ Base Prices</div>
      <div class="tab" onclick="switchTab('available-homes')">üè† Available Homes</div>
    </div>
    
    <div class="tab-content active" id="tab-homesites"></div>
    <div class="tab-content" id="tab-base-prices"></div>
    <div class="tab-content" id="tab-available-homes"></div>
  </div>
</div>

<!-- Audit Log Modal -->
<div id="auditModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:100; justify-content:center; align-items:center;">
  <div style="background:white; border-radius:12px; width:800px; max-height:80vh; overflow-y:auto; padding:32px; position:relative;">
    <button onclick="document.getElementById('auditModal').style.display='none'" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
    <h2 style="font-family:'Playfair Display',serif; color:#6B1D2A; margin-bottom:16px;">Price Change Audit Log</h2>
    <div id="auditContent"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = '';
let currentUser = null;
let currentCommunity = null;
let currentTab = 'homesites';
let pendingChanges = {};

// Auth
async function api(url, opts = {}) {
  const res = await fetch(API + url, { ...opts, headers: { 'Content-Type': 'application/json', ...opts.headers } });
  if (res.status === 401) { showLogin(); throw new Error('Unauthorized'); }
  return res;
}

document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  try {
    const res = await fetch(API + '/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error);
    currentUser = data.user;
    showApp();
  } catch (err) {
    const el = document.getElementById('loginError');
    el.textContent = err.message;
    el.style.display = 'block';
  }
});

function showLogin() {
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
}

async function showApp() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('userName').textContent = currentUser.name;
  await loadCommunities();
}

async function logout() {
  await fetch(API + '/api/logout', { method: 'POST' });
  currentUser = null;
  showLogin();
}

// Check session
(async () => {
  try {
    const res = await fetch(API + '/api/me');
    if (res.ok) { currentUser = (await res.json()).user; showApp(); }
  } catch {}
})();

// Communities
async function loadCommunities() {
  const res = await api('/api/communities');
  const communities = await res.json();
  const sel = document.getElementById('communitySelect');
  sel.innerHTML = communities.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  if (communities.length) { currentCommunity = communities[0]; loadCommunity(); }
}

async function loadCommunity() {
  const id = document.getElementById('communitySelect').value;
  pendingChanges = {};
  await Promise.all([loadHomesites(id), loadBasePrices(id), loadAvailableHomes(id)]);
}

// Homesites
async function loadHomesites(cid) {
  const res = await api(`/api/communities/${cid}/homesites`);
  const data = await res.json();
  const el = document.getElementById('tab-homesites');
  el.innerHTML = `
    <table class="data-table">
      <thead><tr><th>Lot</th><th>Address</th><th>Direction</th><th>SQ.FT</th><th>Homesite Premium</th></tr></thead>
      <tbody>${data.map(d => `<tr>
        <td><input class="field-input" type="text" value="${d.lot_number}" data-type="homesites" data-id="${d.id}" data-field="lot_number" onchange="fieldChanged(this)"></td>
        <td><input class="field-input" type="text" value="${d.address}" data-type="homesites" data-id="${d.id}" data-field="address" onchange="fieldChanged(this)"></td>
        <td><input class="field-input short" type="text" value="${d.front_facing_direction}" data-type="homesites" data-id="${d.id}" data-field="front_facing_direction" onchange="fieldChanged(this)"></td>
        <td><input class="field-input short" type="text" value="${d.sqft}" data-type="homesites" data-id="${d.id}" data-field="sqft" onchange="fieldChanged(this)"></td>
        <td style="text-align:center"><input class="price-input" type="text" value="${formatPrice(d.premium_price)}" data-type="homesites" data-id="${d.id}" data-original="${d.premium_price}" onchange="priceChanged(this)" onfocus="this.select()"></td>
      </tr>`).join('')}</tbody>
    </table>
    ${actionsHTML('homesites')}`;
}

// Base Prices
async function loadBasePrices(cid) {
  const [plansRes, syncRes] = await Promise.all([
    api(`/api/communities/${cid}/plans`),
    api('/api/homefiniti/plan-status'),
  ]);
  const data = await plansRes.json();
  const syncStatuses = await syncRes.json();
  
  // Map plan name -> latest sync status
  const syncMap = {};
  syncStatuses.forEach(s => { syncMap[s.plan_name] = s; });
  
  const el = document.getElementById('tab-base-prices');
  el.innerHTML = `
    <table class="data-table">
      <thead><tr><th>Plan</th><th>Total SQFT</th><th>Finished SQFT</th><th>Floors</th><th>Beds</th><th>Baths</th><th>Garage</th><th>Starting At</th><th>Homefiniti</th></tr></thead>
      <tbody>${data.map(d => {
        const sync = syncMap[d.name] || null;
        const syncBadge = sync
          ? `<span class="sync-badge ${sync.status}" title="${sync.error_message || sync.status}">${sync.status}</span>`
          : `<span class="sync-badge none">‚Äî</span>`;
        return `<tr>
        <td>${d.name}</td>
        <td><input class="field-input short" type="text" value="${d.total_sqft}" data-type="plans" data-id="${d.id}" data-field="total_sqft" onchange="fieldChanged(this)"></td>
        <td><input class="field-input" type="text" value="${d.finished_sqft_range}" data-type="plans" data-id="${d.id}" data-field="finished_sqft_range" onchange="fieldChanged(this)"></td>
        <td><input class="field-input short" type="text" value="${d.floors}" data-type="plans" data-id="${d.id}" data-field="floors" onchange="fieldChanged(this)"></td>
        <td><input class="field-input short" type="text" value="${d.beds_range}" data-type="plans" data-id="${d.id}" data-field="beds_range" onchange="fieldChanged(this)"></td>
        <td><input class="field-input short" type="text" value="${d.baths_range}" data-type="plans" data-id="${d.id}" data-field="baths_range" onchange="fieldChanged(this)"></td>
        <td><input class="field-input short" type="text" value="${d.garage_range}" data-type="plans" data-id="${d.id}" data-field="garage_range" onchange="fieldChanged(this)"></td>
        <td style="text-align:center"><input class="price-input" type="text" value="${formatPrice(d.base_price)}" data-type="plans" data-id="${d.id}" data-original="${d.base_price}" onchange="priceChanged(this)" onfocus="this.select()"></td>
        <td style="text-align:center">${syncBadge}<br><button class="btn-sync" onclick="syncToHomefiniti(${d.id}, this)" title="Sync to Homefiniti">üîÑ Sync</button></td>
      </tr>`;
      }).join('')}</tbody>
    </table>
    ${actionsHTML('base-prices')}`;
}

// Available Homes
async function loadAvailableHomes(cid) {
  const res = await api(`/api/communities/${cid}/available-homes`);
  const data = await res.json();
  const el = document.getElementById('tab-available-homes');
  el.innerHTML = `
    <table class="data-table">
      <thead><tr><th>Plan</th><th>Address</th><th>Total SQFT</th><th>Finished</th><th>Beds</th><th>Baths</th><th>Gar</th><th>Est. Move In</th><th>Price</th></tr></thead>
      <tbody>${data.map(d => `<tr>
        <td><input class="field-input" type="text" value="${d.plan_name}" data-type="available-homes" data-id="${d.id}" data-field="plan_name" onchange="fieldChanged(this)"></td>
        <td><input class="field-input" type="text" value="${d.address}" data-type="available-homes" data-id="${d.id}" data-field="address" onchange="fieldChanged(this)"></td>
        <td><input class="field-input short" type="text" value="${d.total_sqft}" data-type="available-homes" data-id="${d.id}" data-field="total_sqft" onchange="fieldChanged(this)"></td>
        <td><input class="field-input short" type="text" value="${d.finished_sqft}" data-type="available-homes" data-id="${d.id}" data-field="finished_sqft" onchange="fieldChanged(this)"></td>
        <td><input class="field-input short" type="text" value="${d.beds}" data-type="available-homes" data-id="${d.id}" data-field="beds" onchange="fieldChanged(this)"></td>
        <td><input class="field-input short" type="text" value="${d.baths}" data-type="available-homes" data-id="${d.id}" data-field="baths" onchange="fieldChanged(this)"></td>
        <td><input class="field-input short" type="text" value="${d.garage}" data-type="available-homes" data-id="${d.id}" data-field="garage" onchange="fieldChanged(this)"></td>
        <td><input class="field-input" type="text" value="${d.est_move_in}" data-type="available-homes" data-id="${d.id}" data-field="est_move_in" onchange="fieldChanged(this)"></td>
        <td style="text-align:center"><input class="price-input" type="text" value="${formatPrice(d.price)}" data-type="available-homes" data-id="${d.id}" data-original="${d.price}" onchange="priceChanged(this)" onfocus="this.select()"></td>
      </tr>`).join('')}</tbody>
    </table>
    ${actionsHTML('available-homes')}`;
}

function actionsHTML(type) {
  return `
    <div class="actions">
      <div class="pdf-actions">
        <button class="btn btn-secondary" onclick="generatePDF('${type}')">üìÑ Generate PDF</button>
        <button class="btn btn-secondary" onclick="downloadPDF('${type}')">‚¨áÔ∏è Download PDF</button>
      </div>
      <div>
        <span class="save-status" id="status-${type}"></span>
        <button class="btn btn-primary" onclick="saveAll('${type}')">üíæ Save Changes</button>
      </div>
    </div>`;
}

function formatPrice(n) {
  return '$' + Number(n).toLocaleString('en-US');
}

function parsePrice(s) {
  return parseInt(s.replace(/[$,]/g, ''), 10) || 0;
}

let pendingFieldChanges = {};

function fieldChanged(input) {
  const key = `${input.dataset.type}-${input.dataset.id}-${input.dataset.field}`;
  input.classList.add('changed');
  input.classList.remove('saved');
  pendingFieldChanges[key] = { type: input.dataset.type, id: input.dataset.id, field: input.dataset.field, value: input.value };
}

function priceChanged(input) {
  const raw = parsePrice(input.value);
  input.value = formatPrice(raw);
  const original = parseInt(input.dataset.original);
  const key = `${input.dataset.type}-${input.dataset.id}`;
  if (raw !== original) {
    input.classList.add('changed');
    input.classList.remove('saved');
    pendingChanges[key] = { type: input.dataset.type, id: input.dataset.id, price: raw };
  } else {
    input.classList.remove('changed');
    delete pendingChanges[key];
  }
}

async function saveAll(tabType) {
  const tabTypeMap = { 'base-prices': 'plans', 'homesites': 'homesites', 'available-homes': 'available-homes' };
  const matchType = tabTypeMap[tabType] || tabType;
  const changes = Object.values(pendingChanges).filter(c => c.type === matchType || c.type === tabType);
  const fieldChanges = Object.values(pendingFieldChanges).filter(c => c.type === matchType || c.type === tabType);
  if (!changes.length && !fieldChanges.length) { toast('No changes to save', 'info'); return; }
  
  const statusEl = document.getElementById(`status-${tabType}`);
  statusEl.textContent = 'Saving...';
  statusEl.className = 'save-status';
  
  try {
    for (const change of changes) {
      await api(`/api/${change.type}/${change.id}/price`, {
        method: 'PUT',
        body: JSON.stringify({ price: change.price }),
      });
      // Update original value and style
      const input = document.querySelector(`input[data-type="${change.type}"][data-id="${change.id}"]`);
      if (input) {
        input.dataset.original = change.price;
        input.classList.remove('changed');
        input.classList.add('saved');
        setTimeout(() => input.classList.remove('saved'), 2000);
      }
      delete pendingChanges[`${change.type}-${change.id}`];
    }
    for (const fc of fieldChanges) {
      await api(`/api/${fc.type}/${fc.id}/field`, {
        method: 'PUT',
        body: JSON.stringify({ field: fc.field, value: fc.value }),
      });
      const input = document.querySelector(`input[data-type="${fc.type}"][data-id="${fc.id}"][data-field="${fc.field}"]`);
      if (input) { input.classList.remove('changed'); input.classList.add('saved'); setTimeout(() => input.classList.remove('saved'), 2000); }
      delete pendingFieldChanges[`${fc.type}-${fc.id}-${fc.field}`];
    }
    const totalSaved = changes.length + fieldChanges.length;
    statusEl.textContent = `‚úÖ ${totalSaved} change(s) saved`;
    statusEl.className = 'save-status success';
    toast(`${totalSaved} change(s) saved successfully!`, 'success');
  } catch (err) {
    statusEl.textContent = '‚ùå Save failed';
    statusEl.className = 'save-status error';
    toast('Failed to save: ' + err.message, 'error');
  }
}

async function generatePDF(type) {
  const cid = document.getElementById('communitySelect').value;
  toast('Generating PDF...', 'info');
  try {
    const res = await api(`/api/communities/${cid}/generate-pdf/${type}`, { method: 'POST' });
    const data = await res.json();
    if (data.ok) {
      toast('PDF generated! Click Download to get it.', 'success');
    } else {
      toast('PDF generation failed: ' + (data.error || 'Unknown'), 'error');
    }
  } catch (err) { toast('Error: ' + err.message, 'error'); }
}

async function downloadPDF(type) {
  const cid = document.getElementById('communitySelect').value;
  window.open(`/api/communities/${cid}/download-pdf/${type}`, '_blank');
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  const tabs = ['homesites', 'base-prices', 'available-homes'];
  const idx = tabs.indexOf(tab);
  document.querySelectorAll('.tab')[idx].classList.add('active');
  document.getElementById(`tab-${tab}`).classList.add('active');
}

async function showAuditLog() {
  const modal = document.getElementById('auditModal');
  modal.style.display = 'flex';
  const res = await api('/api/audit-log');
  const logs = await res.json();
  const content = document.getElementById('auditContent');
  if (!logs.length) { content.innerHTML = '<p style="color:#888;">No price changes recorded yet.</p>'; return; }
  
  const typeLabels = { plans: 'Base Price', homesites: 'Homesite', 'available-homes': 'Available Home' };
  const typeBadges = { plans: 'badge-plan', homesites: 'badge-lot', 'available-homes': 'badge-home' };
  
  content.innerHTML = `<table class="audit-table">
    <thead><tr><th>When</th><th>Who</th><th>Type</th><th>Item #</th><th>Old Price</th><th>New Price</th></tr></thead>
    <tbody>${logs.map(l => `<tr>
      <td>${new Date(l.changed_at).toLocaleString()}</td>
      <td>${l.user_name}</td>
      <td><span class="badge ${typeBadges[l.entity_type] || ''}">${typeLabels[l.entity_type] || l.entity_type}</span></td>
      <td>#${l.entity_id}</td>
      <td>${formatPrice(l.old_value)}</td>
      <td><strong>${formatPrice(l.new_value)}</strong></td>
    </tr>`).join('')}</tbody>
  </table>`;
}

// Homefiniti Sync
async function syncToHomefiniti(planId, btn) {
  btn.disabled = true;
  btn.textContent = '‚è≥ Syncing...';
  toast('Syncing to Homefiniti...', 'info');
  
  try {
    const res = await api(`/api/homefiniti/sync/${planId}`, { method: 'POST' });
    const data = await res.json();
    if (data.ok) {
      toast(`${data.message} - syncing in background`, 'success');
      // Poll for completion
      pollSyncStatus(btn);
    } else {
      toast('Sync failed: ' + (data.error || 'Unknown'), 'error');
      btn.disabled = false;
      btn.textContent = 'üîÑ Sync';
    }
  } catch (err) {
    toast('Sync error: ' + err.message, 'error');
    btn.disabled = false;
    btn.textContent = 'üîÑ Sync';
  }
}

function pollSyncStatus(btn) {
  let attempts = 0;
  const poll = setInterval(async () => {
    attempts++;
    if (attempts > 30) { // 60 seconds max
      clearInterval(poll);
      btn.disabled = false;
      btn.textContent = 'üîÑ Sync';
      return;
    }
    try {
      const res = await api('/api/homefiniti/plan-status');
      const statuses = await res.json();
      const hasPending = statuses.some(s => s.status === 'pending');
      if (!hasPending) {
        clearInterval(poll);
        // Reload the base prices tab to show updated sync statuses
        const cid = document.getElementById('communitySelect').value;
        await loadBasePrices(cid);
        toast('Homefiniti sync complete!', 'success');
      }
    } catch {}
  }, 2000);
}

function toast(msg, type = 'info') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast ${type} show`;
  setTimeout(() => el.classList.remove('show'), 3000);
}
</script>
</body>
</html>
